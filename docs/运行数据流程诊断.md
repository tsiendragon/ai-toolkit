# 运行数据流程诊断指南

我已经为 Flux Kontext Dev 训练添加了详细的数据流程日志记录。现在您可以重新运行训练来获得完整的诊断信息。

## 🔍 添加的日志覆盖范围

### 1. DataLoader 创建阶段
- `get_dataloader_from_datasets()` 函数
- 数据集配置信息
- buckets vs 标准模式检测
- DataLoader 参数设置

### 2. AiToolkitDataset 初始化
- 数据集路径和配置
- 文件列表大小
- 缓存设置
- buckets 配置

### 3. Buckets 设置过程
- `setup_buckets()` 详细流程
- 每个 bucket 的文件数量
- `build_batch_indices()` 过程
- 最终批次数量统计

### 4. 数据集访问
- `__len__()` 调用
- `__getitem__()` 调用
- 批次索引访问

### 5. 分布式训练准备
- accelerator.prepare() 前后状态
- batch_sampler 检查
- 进程数和设备信息

### 6. 训练循环数据迭代器
- 迭代器创建过程
- 错误捕获和诊断

## 🚀 使用方法

### 方法 1: 启用日志记录脚本
```bash
# 在训练前运行
python enable_data_flow_logging.py --log-file data_flow_debug.log

# 然后运行您的训练命令
```

### 方法 2: 在训练脚本中导入
```python
# 在训练脚本开头添加
import enable_data_flow_logging
enable_data_flow_logging.enable_info_logging("data_flow.log")
```

### 方法 3: 手动配置日志
```python
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s | %(levelname)-8s | %(name)-30s | %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler('training_debug.log')
    ]
)
```

## 📊 关键日志标识符

运行训练时，查找这些关键标识符：

- `🔍 [DATA_FLOW]` - DataLoader 创建过程
- `🔍 [DATASET_INIT]` - 数据集初始化
- `🔍 [SETUP_EPOCH]` - epoch 设置过程
- `🔍 [BUCKETS]` - buckets 相关操作
- `🔍 [DATASET]` - 数据集访问操作
- `🔍 [TRAIN_PROCESS]` - 训练过程数据加载
- `🔍 [DISTRIBUTED]` - 分布式训练准备
- `🔍 [TRAIN_LOOP]` - 训练循环数据迭代
- `❌` - 错误信息
- `⚠️` - 警告信息

## 🔧 诊断重点

运行训练后，重点检查：

1. **DataLoader 创建是否成功**
   ```
   🔍 [DATA_FLOW] DataLoader 创建完成
   🔍 [DATA_FLOW] - DataLoader 长度: XXXX
   ```

2. **buckets 模式检测**
   ```
   🔍 [DATA_FLOW] 创建 buckets 模式 DataLoader
   🔍 [BUCKETS] - 总 batch_indices 数: XXXX
   ```

3. **分布式环境准备**
   ```
   🔍 [DISTRIBUTED] - batch_sampler: <class 'XXX'> 或 None
   ```

4. **数据迭代器创建**
   ```
   🔍 [TRAIN_LOOP] - 主数据迭代器创建成功
   ```

5. **错误位置定位**
   ```
   ❌ [DISTRIBUTED] batch_sampler 为 None！
   ❌ [TRAIN_LOOP] 创建主数据迭代器失败: XXX
   ```

## 📋 常见问题诊断

### 问题 1: batch_sampler 为 None
查找日志：
```
❌ [DISTRIBUTED] batch_sampler 为 None！
```
**解决**: 数据不够分布式训练，或 buckets 配置问题

### 问题 2: 数据集大小不匹配
查找日志：
```
🔍 [BUCKETS] - 总 batch_indices 数: X
🔍 [DISTRIBUTED] - 进程数: Y
```
**检查**: X 能否被 Y 整除

### 问题 3: 迭代器创建失败
查找日志：
```
❌ [TRAIN_LOOP] 创建主数据迭代器失败
```
**分析**: 检查前面的 DataLoader 创建和准备过程

现在请重新运行您的分布式训练命令，日志将提供详细的诊断信息！
